---
/**
 * Analytics component — deankeesey.com
 *
 * Direct-load GA4 + Microsoft Clarity + optional Facebook Pixel.
 * No GTM container (not needed — no non-technical staff managing tags).
 * No Partytown (GA4/Clarity are direct; PostHog is handled separately).
 *
 * Props:
 *   ga4Id     — GA4 measurement ID (G-XXXXXXXXXX)
 *   clarityId — Microsoft Clarity project ID
 *   fbPixelId — Facebook Pixel ID (optional)
 *
 * Renders nothing silently when all props are absent (safe in local/CI builds).
 */

interface Props {
  ga4Id?: string;
  clarityId?: string;
  fbPixelId?: string;
}

const { ga4Id, clarityId, fbPixelId } = Astro.props;
---

{ga4Id && (
  <Fragment>
    {/* GA4: init dataLayer + gtag stub, then dynamically load gtag.js.
        Using document.createElement avoids the is:inline + src contradiction
        where Astro's is:inline directive and an external src are mutually
        exclusive — the src was silently dropped in the previous implementation. */}
    <script is:inline define:vars={{ ga4Id }}>
      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      gtag('js', new Date());
      // send_page_view: false — the astro:page-load handler below fires all
      // page views (including the initial load), so we never double-count.
      gtag('config', ga4Id, { send_page_view: false });

      var _s = document.createElement('script');
      _s.async = true;
      _s.src = 'https://www.googletagmanager.com/gtag/js?id=' + ga4Id;
      document.head.appendChild(_s);
    </script>

    {/* GA4: re-fire config on every ClientRouter navigation.
        astro:page-load fires on initial load AND soft navs, so this is
        the single source of truth for page_view events. */}
    <script is:inline define:vars={{ ga4Id }}>
      document.addEventListener('astro:page-load', function() {
        if (window.gtag) {
          window.gtag('config', ga4Id, {
            page_path: window.location.pathname + window.location.search
          });
        }
      });
    </script>

    {/* Event tracking: scroll depth + outbound links + contact clicks.
        Wrapped in astro:page-load so listeners re-attach after each
        ClientRouter body swap. Scroll handler is torn down and rebuilt
        per-page to reset thresholds and prevent listener accumulation. */}
    <script is:inline>
      (function() {
        var _scrollHandler = null;

        function setupTracking() {
          // --- Scroll depth ---
          var trackedDepths = new Set();
          if (_scrollHandler) {
            window.removeEventListener('scroll', _scrollHandler);
          }
          _scrollHandler = function() {
            var total = document.documentElement.scrollHeight - window.innerHeight;
            if (total <= 0) return;
            var pct = (window.scrollY / total) * 100;
            [25, 50, 75, 90].forEach(function(d) {
              if (pct >= d && !trackedDepths.has(d)) {
                trackedDepths.add(d);
                if (window.gtag) {
                  window.gtag('event', 'scroll', {
                    percent_scrolled: d,
                    page_location: window.location.pathname
                  });
                }
              }
            });
          };
          window.addEventListener('scroll', _scrollHandler, { passive: true });

          // --- Outbound links ---
          document.querySelectorAll('a[href^="http"]').forEach(function(link) {
            try {
              var u = new URL(link.href);
              if (u.hostname === window.location.hostname) return;
              link.addEventListener('click', function() {
                if (window.gtag) {
                  window.gtag('event', 'click', {
                    event_category: 'outbound',
                    link_url: this.href,
                    link_domain: u.hostname,
                    link_text: (this.textContent || '').trim().slice(0, 100)
                  });
                }
              });
            } catch(e) {}
          });

          // --- Contact clicks ---
          document.querySelectorAll('a[href^="mailto:"]').forEach(function(link) {
            link.addEventListener('click', function() {
              if (window.gtag) {
                window.gtag('event', 'email_click', {
                  event_category: 'contact',
                  page_location: window.location.pathname
                });
              }
            });
          });
          document.querySelectorAll('a[href^="tel:"]').forEach(function(link) {
            link.addEventListener('click', function() {
              if (window.gtag) {
                window.gtag('event', 'phone_click', {
                  event_category: 'contact',
                  page_location: window.location.pathname
                });
              }
            });
          });
        }

        document.addEventListener('astro:page-load', setupTracking);
      })();
    </script>
  </Fragment>
)}

{clarityId && (
  <script is:inline define:vars={{ clarityId }}>
    (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
      t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window,document,"clarity","script",clarityId);
  </script>
)}

{fbPixelId && (
  <Fragment>
    <script is:inline define:vars={{ fbPixelId }}>
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window,document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', fbPixelId);
      fbq('track', 'PageView');
    </script>
    <noscript>
      <img height="1" width="1" style="display:none"
           src={`https://www.facebook.com/tr?id=${fbPixelId}&ev=PageView&noscript=1`}
      />
    </noscript>
  </Fragment>
)}
