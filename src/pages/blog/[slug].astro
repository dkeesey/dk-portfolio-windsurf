---
import { getCollection, render } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import Layout from '@/components/layout/Layout.astro';
import { Container } from '@/components/ui/container';
import { Badge } from '@/components/ui/badge';
import type { SEOProps } from '@/types';

// Prerender all blog posts at build time for optimal performance
export const prerender = true;

// Define props type for type safety
interface Props {
  entry: CollectionEntry<'blog'>;
}

// Generate static paths for all blog posts
export async function getStaticPaths() {
  const blogEntries = await getCollection('blog', ({ data }) => {
    // In production, filter out draft posts
    return import.meta.env.PROD ? !data.draft : true;
  });

  return blogEntries.map(entry => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

// Get the blog post from the props with type safety
const { entry } = Astro.props as Props;

// Guard against undefined entry (shouldn't happen with static paths, but defensive coding)
if (!entry) {
  return Astro.redirect('/blog');
}

const { Content } = await render(entry);

// Format the date for display
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date);
};

// Share URLs
const siteUrl = 'https://deankeesey.com';
const postUrl = `${siteUrl}/blog/${entry.id}`;
const linkedInShareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(postUrl)}`;
const twitterShareUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(postUrl)}&text=${encodeURIComponent(entry.data.title)}`;

// SEO props
const seo: SEOProps = {
  title: `${entry.data.title} - Dean Keesey's Blog`,
  description: entry.data.description,
  type: entry.data.type || 'article',
  image: entry.data.image,
  publishDate: entry.data.publishDate,
};
---

<Layout {seo}>
  <Container as="main" className="py-12">
    <article class="mx-auto max-w-3xl">
      <header class="mb-8 text-center">
        <div class="mb-2 flex items-center justify-center gap-2 text-sm text-muted-foreground">
          <time datetime={entry.data.publishDate.toISOString()}>
            {formatDate(entry.data.publishDate)}
          </time>
          <span>â€¢</span>
          <span>{entry.data.readingTime || '5'} min read</span>
        </div>
        <h1 class="mb-4 text-4xl font-bold tracking-tight sm:text-5xl">
          {entry.data.title}
        </h1>
        <p class="text-xl text-muted-foreground">
          {entry.data.description}
        </p>
        <div class="mt-4 flex flex-wrap justify-center gap-2">
          {entry.data.tags.map((tag: string) => (
            <Badge variant="secondary">{tag}</Badge>
          ))}
        </div>
      </header>

      {entry.data.image && (
        <div class="mb-8 overflow-hidden rounded-lg">
          <img
            src={entry.data.image}
            alt={`Cover image for ${entry.data.title}`}
            class="h-auto w-full object-cover"
          />
        </div>
      )}

      <div class="prose prose-lg mx-auto max-w-none dark:prose-invert">
        <Content />
      </div>

      <div class="mt-12 border-t pt-6 space-y-4">
        {/* Share buttons */}
        <div class="flex items-center gap-3">
          <span class="text-sm text-muted-foreground">Share:</span>
          <a
            href={linkedInShareUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 rounded-md bg-[#0A66C2] px-4 py-2 text-sm font-medium text-white hover:bg-[#004182] transition-colors"
          >
            <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
              <path d="M4.98 3.5c0 1.381-1.11 2.5-2.48 2.5s-2.48-1.119-2.48-2.5c0-1.38 1.11-2.5 2.48-2.5s2.48 1.12 2.48 2.5zm.02 4.5h-5v16h5v-16zm7.982 0h-4.968v16h4.969v-8.399c0-4.67 6.029-5.052 6.029 0v8.399h4.988v-10.131c0-7.88-8.922-7.593-11.018-3.714v-2.155z"/>
            </svg>
            LinkedIn
          </a>
          <a
            href={twitterShareUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 rounded-md bg-gray-900 px-4 py-2 text-sm font-medium text-white hover:bg-gray-700 transition-colors"
          >
            <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.748l7.73-8.835L1.254 2.25H8.08l4.253 5.622zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
            X
          </a>
        </div>

        <div class="flex items-center justify-between">
          <a href="/blog" class="text-primary hover:underline">
            &larr; Back to all posts
          </a>
          {entry.data.author && (
            <p class="text-sm text-muted-foreground">
              Written by <span class="font-medium">{entry.data.author}</span>
            </p>
          )}
        </div>
      </div>
    </article>
  </Container>
</Layout> 